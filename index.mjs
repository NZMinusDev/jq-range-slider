import express from"express";import path from"path";import isEqual from"lodash/isEqual.js";import cloneDeep from"lodash/cloneDeep.js";const isDev="development"===process.env.NODE_ENV,app=express(),jsonParser=express.json(),state={value:[50]};let timerId;isDev?app.use(express.static(path.resolve("app/public"))):app.use(express.static(path.resolve("./"))),app.use("/fetch/post/state",jsonParser,(e,t,s)=>{switch(e.body.mode){case"get":console.log("getState: ",state),t.json(state);break;case"set":state.value=JSON.parse(e.body.state).value,console.log("setState: ",state),t.sendStatus(200);break;default:t.sendStatus(200)}s()}),app.use("/stateChanger",(e,t,s)=>{t.writeHead(200,{Connection:"keep-alive","Content-Type":"text/event-stream","Cache-Control":"no-cache"});let a=cloneDeep(state);void 0===timerId&&clearTimeout(timerId),timerId=setInterval(()=>{isEqual(a,state)||(t.write(`data: {"state": ${JSON.stringify(state)}}\nid: ${Date.now()}\n\n`),console.log("whenStateIsChanged: ",state)),a=cloneDeep(state)},3e3),s()}),app.listen(process.env.PORT||8080,()=>{console.log("Server started at 8080")});